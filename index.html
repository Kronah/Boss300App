<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss 300 - Acesso e Pesquisa</title>
    <!-- Inclui o Tailwind CSS para estilização fácil -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define as fontes Inter (para texto geral) e Cinzel Decorative (para títulos) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Inclui Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Fonte padrão para todo o corpo */
            background-image:
                url('https://lh4.googleusercontent.com/_tiEzXvf6uDRZ1x-lkpcGl8tfFogCXcT9Qo5awoc_5C6oK_bIWabqjfGxafC48vLij-g6KOKSdgQg-_0gmKn99uwOPTY69Q4cghy3irecNGVHvz5hNHy6aqd5Fv3cqln1uu0eN0EFnJJp3SJfWXa2A4'); /* Imagem de fundo do exército de Esparta */
            background-size: cover; /* Faz a imagem cobrir todo o fundo */
            background-position: center; /* Centraliza a imagem no fundo */
            background-repeat: no-repeat; /* Evita que a imagem se repita */
            background-attachment: fixed; /* Mantém a imagem fixa ao rolar */
            display: flex; /* Para posicionar o conteúdo */
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Centraliza verticalmente o conteúdo */
            min-height: 100vh;
            padding: 1rem;
        }
        /* Aplica a fonte "300" (Cinzel Decorative) aos títulos */
        h1, h2 {
            font-family: 'Cinzel Decorative', serif;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* Sombra para realçar o texto */
        }
        /* Estilo para painel de conteúdo */
        .content-panel {
            background-color: rgba(0, 0, 0, 0.5); /* Fundo escuro semi-transparente */
            padding: 2rem; /* Espaçamento interno */
            border-radius: 0.5rem; /* Cantos arredondados */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); /* Sombra */
            color: #ffffff; /* Cor do texto padrão para este painel */
            position: relative; /* Para posicionamento de elementos internos */
            width: 90%;
            max-width: 800px; /* Aumentado para melhor visualização da lista */
        }
        /* Estilo para cada cartão de mob na lista */
        .mob-card {
            background-color: #ffffff; /* Fundo branco sólido */
            border-left: 4px solid #b91c1c; /* Borda vermelha para destaque */
            color: #1a202c; /* Cor do texto padrão para o cartão do mob */
        }

        /* Estilos para o Modal Personalizado (copiados para consistência) */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .custom-modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        /* Estilo para o loader (tela de carregamento) */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            color: white;
            font-size: 1.5rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #b91c1c; /* Cor vermelha para o spinner */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <!-- Overlay de Carregamento Inicial -->
    <div id="loadingOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <!-- Container Principal do App Combinado -->
    <div id="combinedAppContent" class="content-panel mt-16 md:mt-4 text-center hidden">
        <!-- Seção do Validador de Token (Visível para não autenticados/sem token) -->
        <div id="validatorSection">
            <h1 class="text-3xl font-bold text-white mb-6">Validador de Token</h1>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="tokenInput" class="block text-white text-sm font-semibold mb-2 text-left">Insira seu Token</label>
                    <input
                        type="text"
                        id="tokenInput"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700 transition duration-200 placeholder-gray-600 text-black"
                        placeholder="Seu token único"
                    >
                </div>
                <button
                    id="validateTokenButton"
                    class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                >
                    Validar Token
                </button>
                <p id="validationResult" class="text-center text-white text-base mt-4 font-semibold break-all"></p>
                <p id="tokenDetails" class="text-center text-white text-sm mt-2"></p>
                <p id="message-validator" class="text-center text-sm mt-4"></p> <!-- Elemento para exibir mensagens de feedback -->
            </div>
        </div>

        <!-- Seção da Pesquisa de Mobs (Visível após validação do token) -->
        <div id="bossSearchSection" class="hidden">
            <h1 class="text-3xl font-bold text-white mb-6">Boss 300 - Pesquisa de Mobs</h1>
            <p class="text-white text-lg mb-4">Encontre seus adversários espartanos!</p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="mobSearchInput" class="block text-white text-sm font-semibold mb-2 text-left">Pesquisar por Nome ou Número</label>
                    <input
                        type="text"
                        id="mobSearchInput"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700 transition duration-200 placeholder-gray-600 text-black"
                        placeholder="Ex: Leonidas, 45"
                    >
                </div>
                <button
                    id="searchMobButton"
                    class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
                >
                    <i class="fas fa-search mr-2"></i> Pesquisar Mob
                </button>
                <p id="searchMessage" class="text-center text-sm mt-4"></p> <!-- Elemento para exibir mensagens de feedback -->
            </div>

            <h2 class="text-2xl font-bold text-white mb-4">Resultados da Pesquisa</h2>
            <div id="mob-list" class="space-y-4 mb-6 text-left max-h-96 overflow-y-auto p-4 rounded-md border border-gray-400">
                <!-- Mobs serão carregados aqui -->
                <p class="text-white text-center" id="loading-mobs-message">Carregando dados dos mobs...</p>
            </div>
        </div>
        
        <!-- Botão Sair (aparece quando o acesso é concedido) -->
        <button
            id="logoutButton"
            class="mt-4 bg-gray-700 text-white py-2 px-6 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 hidden"
        >
            Sair
        </button>
    </div>

    <!-- Direitos autorais -->
    <p class="text-center text-white text-xs mt-6" id="copyright">
        &copy; 2025 CaMoMiLa. Todos os direitos reservados.
    </p>

    <!-- Modal para Confirmação e Alertas -->
    <div id="customConfirmModal" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <p id="modalMessage" class="text-black text-lg mb-4"></p>
            <!-- Input para o modal, inicialmente oculto -->
            <input type="number" id="modalInput" class="hidden w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700 transition duration-200 placeholder-black mb-4" placeholder="Quantidade de dias" min="1" />
            <div id="modalButtons" class="flex justify-center space-x-4">
                <button id="modalConfirmButton" class="bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900">Confirmar</button>
                <button id="modalCancelButton" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Script JavaScript para a lógica da aplicação combinada -->
    <script type="module">
        console.clear(); // Limpa o console do navegador para depuração mais fácil
        console.log("Iniciando script...");

        // --- Firebase Setup ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        console.log("Firebase SDKs importados.");

        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDVwW_stGdkYpArCLjqsDbBsUiaSihGsUE",
            authDomain: "bossdv-72d16.firebaseapp.com",
            databaseURL: "https://bossdv-72d16-default-rtdb.firebaseio.com",
            projectId: "bossdv-72d16",
            storageBucket: "bossdv-72d16.firebasestorage.app",
            messagingSenderId: "141528827265",
            appId: "1:141528827265:web:531737e108e484a0869480"
        });
        const firebaseConfig = JSON.parse(firebaseConfigString);
        console.log("Firebase Config carregada:", firebaseConfig);

        const appId = 'default-app-id'; // Consistente com a estrutura do Firestore
        console.log("Firestore appId para coleção:", appId);

        console.log("Inicializando Firebase app...");
        const app = initializeApp(firebaseConfig);
        console.log("Firebase app inicializado.");

        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elementos HTML ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const combinedAppContent = document.getElementById('combinedAppContent');
        const validatorSection = document.getElementById('validatorSection');
        const bossSearchSection = document.getElementById('bossSearchSection');
        const copyrightText = document.getElementById('copyright');
        
        // Validador de Token Elements
        const tokenInput = document.getElementById('tokenInput');
        const validateTokenButton = document.getElementById('validateTokenButton');
        const validationResultDisplay = document.getElementById('validationResult');
        const tokenDetailsDisplay = document.getElementById('tokenDetails');
        const messageValidator = document.getElementById('message-validator');

        // Pesquisa de Mobs Elements
        const mobSearchInput = document.getElementById('mobSearchInput');
        const searchMobButton = document.getElementById('searchMobButton');
        const mobListDiv = document.getElementById('mob-list');
        const loadingMobsMessage = document.getElementById('loading-mobs-message');
        const searchMessage = document.getElementById('searchMessage');
        const logoutButton = document.getElementById('logoutButton');

        // Modal Elements
        const customConfirmModal = document.getElementById('customConfirmModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const modalButtons = document.getElementById('modalButtons');

        // --- Global Variables ---
        let currentDeviceId = '';
        let allMobsData = [];
        const JSON_DATA_URL = 'https://raw.githubusercontent.com/Kronah/mob-data/main/dados.json';

        // --- Utility Functions ---

        function showMessage(text, isError = false, targetElement = messageValidator) {
            targetElement.textContent = text;
            if (isError) {
                targetElement.className = 'text-center text-sm mt-4 text-red-600 font-medium';
            } else {
                targetElement.className = 'text-center text-sm mt-4 text-green-600 font-medium';
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('pt-BR')} às ${date.toLocaleTimeString('pt-BR')}`;
        }

        function customModal(message, type = 'alert', inputOptions = {}) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');

                if (type === 'prompt') {
                    modalInput.classList.remove('hidden');
                    modalInput.type = inputOptions.type || 'text';
                    modalInput.placeholder = inputOptions.placeholder || '';
                    modalInput.value = inputOptions.value || '';
                    modalInput.min = inputOptions.min || '';
                    modalInput.max = inputOptions.max || '';
                    modalInput.focus();
                } else {
                    modalInput.classList.add('hidden');
                    modalInput.value = '';
                }

                modalButtons.classList.remove('hidden');
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');

                modalConfirmButton.onclick = null;
                modalCancelButton.onclick = null;

                if (type === 'confirm' || type === 'prompt') {
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        if (type === 'prompt') {
                            resolve(modalInput.value);
                        } else {
                            resolve(true);
                        }
                    };
                    modalCancelButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(false);
                    };
                } else {
                    modalConfirmButton.textContent = 'OK';
                    modalCancelButton.classList.add('hidden');
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(true);
                        modalConfirmButton.textContent = 'Confirmar';
                    };
                }
            });
        }

        async function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('deviceId', deviceId);
                console.log("getDeviceId: Novo Device ID gerado e salvo no localStorage:", deviceId);
            } else {
                console.log("getDeviceId: Device ID existente encontrado no localStorage:", deviceId);
            }
            return deviceId;
        }

        // --- Firebase Auth State Listener ---
        console.log("Configurando onAuthStateChanged listener...");
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged callback executado. User:", user);
            if (!user) {
                console.log("Usuário não autenticado. Tentando autenticação anónima...");
                try {
                    await signInAnonymously(auth);
                    user = auth.currentUser;
                    console.log("Autenticação anónima bem-sucedida. User:", user);
                } catch (error) {
                    console.error("Erro na autenticação anónima:", error);
                    showMessage('Erro na autenticação. Por favor, tente novamente.', true, messageValidator);
                    // Certificar-se de que o carregador é escondido e o conteúdo principal exibido, mesmo em erro de auth
                    loadingOverlay.classList.add('hidden');
                    combinedAppContent.classList.remove('hidden');
                    showValidatorView();
                    return;
                }
            } else {
                console.log("Usuário já autenticado. UID:", user.uid, "Anónimo?", user.isAnonymous);
            }
            currentDeviceId = await getDeviceId();
            console.log("Device ID após onAuthStateChanged:", currentDeviceId);

            // Após a autenticação, tenta validar o acesso via localStorage/Firestore
            initCombinedApp();
        });

        // --- Core Application Logic ---

        // Function to switch between validator and boss search views
        function showAccessGrantedView() {
            validatorSection.classList.add('hidden');
            bossSearchSection.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
            loadMobsData();
            console.log("View: Seção de pesquisa de mobs exibida.");
        }

        function showValidatorView() {
            validatorSection.classList.remove('hidden');
            bossSearchSection.classList.add('hidden');
            logoutButton.classList.add('hidden');
            tokenInput.value = '';
            validationResultDisplay.textContent = '';
            tokenDetailsDisplay.textContent = '';
            messageValidator.textContent = '';
            localStorage.removeItem('lastValidatedToken');
            localStorage.removeItem('lastValidatedDeviceId');
            console.log("View: Seção do validador exibida e localStorage limpo.");
        }

        async function initCombinedApp() {
            console.log("--- Iniciando initCombinedApp ---");
            loadingOverlay.classList.remove('hidden'); // Ensure loader is visible at start

            try {
                const currentDeviceId = await getDeviceId();
                const lastValidatedToken = localStorage.getItem('lastValidatedToken');
                const lastValidatedDeviceId = localStorage.getItem('lastValidatedDeviceId');

                console.log("initCombinedApp: 1. Device ID do localStorage (currentDeviceId):", currentDeviceId);
                console.log("initCombinedApp: 2. Token do loca    </div>
    </div>

    <!-- Script JavaScript para a lógica da aplicação combinada -->
    <script type="module">
        console.clear(); // Limpa o console do navegador para depuração mais fácil

        // --- Firebase Setup ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDVwW_stGdkYpArCLjqsDbBsUiaSihGsUE",
            authDomain: "bossdv-72d16.firebaseapp.com",
            databaseURL: "https://bossdv-72d16-default-rtdb.firebaseio.com",
            projectId: "bossdv-72d16",
            storageBucket: "bossdv-72d16.firebasestorage.app",
            messagingSenderId: "141528827265",
            appId: "1:141528827265:web:531737e108e484a0869480"
        });
        const firebaseConfig = JSON.parse(firebaseConfigString);
        const appId = 'default-app-id'; // Consistente com a estrutura do Firestore

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elementos HTML ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const combinedAppContent = document.getElementById('combinedAppContent');
        const validatorSection = document.getElementById('validatorSection');
        const bossSearchSection = document.getElementById('bossSearchSection');
        const copyrightText = document.getElementById('copyright');
        
        // Validador de Token Elements
        // Removido: const userInfoValidator = document.getElementById('user-info-validator');
        // Removido: const deviceIdDisplay = document.getElementById('device-id-display');
        const tokenInput = document.getElementById('tokenInput');
        const validateTokenButton = document.getElementById('validateTokenButton');
        const validationResultDisplay = document.getElementById('validationResult');
        const tokenDetailsDisplay = document.getElementById('tokenDetails');
        const messageValidator = document.getElementById('message-validator');

        // Pesquisa de Mobs Elements
        const mobSearchInput = document.getElementById('mobSearchInput');
        const searchMobButton = document.getElementById('searchMobButton');
        const mobListDiv = document.getElementById('mob-list');
        const loadingMobsMessage = document.getElementById('loading-mobs-message');
        const searchMessage = document.getElementById('searchMessage');
        const logoutButton = document.getElementById('logoutButton'); // Novo botão Sair

        // Modal Elements
        const customConfirmModal = document.getElementById('customConfirmModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const modalButtons = document.getElementById('modalButtons');

        // --- Global Variables ---
        let currentDeviceId = '';
        let allMobsData = []; // Para armazenar todos os dados dos mobs
        const JSON_DATA_URL = 'https://raw.githubusercontent.com/Kronah/mob-data/main/dados.json';

        // --- Utility Functions ---

        function showMessage(text, isError = false, targetElement = messageValidator) {
            targetElement.textContent = text;
            if (isError) {
                targetElement.className = 'text-center text-sm mt-4 text-red-600 font-medium';
            } else {
                targetElement.className = 'text-center text-sm mt-4 text-green-600 font-medium';
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('pt-BR')} às ${date.toLocaleTimeString('pt-BR')}`;
        }

        function customModal(message, type = 'alert', inputOptions = {}) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');

                if (type === 'prompt') {
                    modalInput.classList.remove('hidden');
                    modalInput.type = inputOptions.type || 'text';
                    modalInput.placeholder = inputOptions.placeholder || '';
                    modalInput.value = inputOptions.value || '';
                    modalInput.min = inputOptions.min || '';
                    modalInput.max = inputOptions.max || '';
                    modalInput.focus();
                } else {
                    modalInput.classList.add('hidden');
                    modalInput.value = '';
                }

                modalButtons.classList.remove('hidden');
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');

                modalConfirmButton.onclick = null;
                modalCancelButton.onclick = null;

                if (type === 'confirm' || type === 'prompt') {
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        if (type === 'prompt') {
                            resolve(modalInput.value);
                        } else {
                            resolve(true);
                        }
                    };
                    modalCancelButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(false);
                    };
                } else {
                    modalConfirmButton.textContent = 'OK';
                    modalCancelButton.classList.add('hidden');
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(true);
                        modalConfirmButton.textContent = 'Confirmar';
                    };
                }
            });
        }

        async function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    await signInAnonymously(auth);
                    user = auth.currentUser;
                    console.log("Sessão anónima iniciada.");
                } catch (error) {
                    console.error("Erro na autenticação anónima:", error);
                    showMessage('Erro na autenticação. Por favor, tente novamente.', true);
                    // Removido: userInfoValidator.textContent = 'Erro ao carregar sessão.';
                    return;
                }
            }
            // Removido: userInfoValidator.textContent = `Sessão Iniciada como: ${user.isAnonymous ? 'Anónimo' : user.email}`;
            currentDeviceId = await getDeviceId();
            // Removido: deviceIdDisplay.textContent = currentDeviceId;

            // Após a autenticação, tenta validar o acesso via localStorage/Firestore
            initCombinedApp();
        });

        // --- Core Application Logic ---

        // Function to switch between validator and boss search views
        function showAccessGrantedView() {
            validatorSection.classList.add('hidden');
            bossSearchSection.classList.remove('hidden');
            logoutButton.classList.remove('hidden'); // Mostra o botão Sair
            loadMobsData(); // Carrega os dados dos mobs quando o acesso é concedido
        }

        function showValidatorView() {
            validatorSection.classList.remove('hidden');
            bossSearchSection.classList.add('hidden');
            logoutButton.classList.add('hidden'); // Esconde o botão Sair
            tokenInput.value = ''; // Limpa o campo do token
            validationResultDisplay.textContent = '';
            tokenDetailsDisplay.textContent = '';
            messageValidator.textContent = '';
            localStorage.removeItem('lastValidatedToken');
            localStorage.removeItem('lastValidatedDeviceId');
        }

        async function initCombinedApp() {
            loadingOverlay.classList.remove('hidden'); // Always show loader at start
            console.log("--- Iniciando initCombinedApp ---");

            try {
                const currentDeviceId = await getDeviceId();
                const lastValidatedToken = localStorage.getItem('lastValidatedToken');
                const lastValidatedDeviceId = localStorage.getItem('lastValidatedDeviceId');

                console.log("1. Device ID do localStorage (currentDeviceId):", currentDeviceId);
                console.log("2. Token do localStorage (lastValidatedToken):", lastValidatedToken);
                console.log("3. Device ID do localStorage (lastValidatedDeviceId):", lastValidatedDeviceId);

                let accessGranted = false;

                if (lastValidatedToken && lastValidatedDeviceId === currentDeviceId) {
                    console.log("4. Dados de validação encontrados no localStorage. Verificando no Firestore...");
                    
                    const tokensCollectionPath = `artifacts/${appId}/public/data/generatedTokens`;
                    const tokensCollectionRef = collection(db, tokensCollectionPath);
                    
                    const q = query(
                        tokensCollectionRef, 
                        where("token", "==", lastValidatedToken),
                        where("deviceId", "==", currentDeviceId)
                    );
                    console.log("5. Executando query no Firestore com token E deviceId. Token:", lastValidatedToken, "DeviceId:", currentDeviceId);

                    const querySnapshot = await getDocs(q);
                    console.log("6. Resultados da query (número de documentos encontrados):", querySnapshot.docs.length);

                    if (!querySnapshot.empty) {
                        const tokenDoc = querySnapshot.docs[0];
                        const tokenData = tokenDoc.data();
                        console.log("7. Dados completos do token do Firestore:", tokenData);
                        
                        const now = Date.now();
                        const isExpired = tokenData.expirationTimestamp <= now;
                        console.log("8. Verificando expiração: Timestamp de expiração:", tokenData.expirationTimestamp, "Agora:", now, "Expirado?", isExpired);

                        if (!isExpired) {
                            accessGranted = true;
                            console.log("9. Acesso concedido: Token válido e vinculado encontrado no Firestore via localStorage.");
                        } else {
                            console.log("9. Acesso negado: Token do localStorage expirado no Firestore. Limpando localStorage.");
                            localStorage.removeItem('lastValidatedToken');
                            localStorage.removeItem('lastValidatedDeviceId');
                        }
                    } else {
                        console.log("6. Acesso negado: Token do localStorage não encontrado ou deviceId não corresponde no Firestore. Limpando localStorage.");
                        localStorage.removeItem('lastValidatedToken');
                        localStorage.removeItem('lastValidatedDeviceId');
                    }
                } else {
                    console.log("4. Dados de validação ausentes ou inconsistentes no localStorage. Exibindo validador.");
                }

                if (accessGranted) {
                    showAccessGrantedView();
                    console.log("10. Exibindo tela de pesquisa de mobs.");
                } else {
                    showValidatorView();
                    console.log("10. Exibindo tela do validador de token.");
                }

                loadingOverlay.classList.add('hidden'); // Hide loader once init is done
                combinedAppContent.classList.remove('hidden'); // Show main content
            } catch (error) {
                console.error("ERRO FATAL (initCombinedApp):", error);
                loadingOverlay.classList.add('hidden');
                customModal('Erro ao iniciar. Por favor, recarregue a página. Verifique a consola para detalhes.', 'alert');
                showValidatorView(); // Fallback to validator view
                combinedAppContent.classList.remove('hidden'); // Show main content
            }
        }

        // --- Token Validation Logic (from index.html) ---
        validateTokenButton.addEventListener('click', async () => {
            const tokenValue = tokenInput.value.trim();
            validationResultDisplay.textContent = '';
            tokenDetailsDisplay.textContent = '';
            showMessage(''); // Clear previous messages

            if (!tokenValue) {
                showMessage('Por favor, insira um token para validar.', true, messageValidator);
                return;
            }

            try {
                let decodedToken;
                try {
                    decodedToken = atob(tokenValue);
                } catch (e) {
                    showMessage('Token inválido. Formato incorreto (Base64).', true, messageValidator);
                    return;
                }

                const tokensCollectionRef = collection(db, `artifacts/${appId}/public/data/generatedTokens`);
                console.log(`[VALIDADOR] A procurar token na coleção: artifacts/${appId}/public/data/generatedTokens com valor: ${tokenValue}`);
                const q = query(tokensCollectionRef, where("token", "==", tokenValue));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Token não encontrado. Verifique o valor.', true, messageValidator);
                    return;
                }

                const tokenDoc = querySnapshot.docs[0];
                const tokenData = tokenDoc.data();
                const tokenId = tokenDoc.id;

                const now = Date.now();
                const isExpired = tokenData.expirationTimestamp <= now;
                const isLinked = !!tokenData.deviceId;

                tokenDetailsDisplay.innerHTML = `
                    Nome: ${tokenData.userName}<br>
                    Vence em: ${formatTimestamp(tokenData.expirationTimestamp)} ${isExpired ? '(EXPIRADO)' : ''}<br>
                    Gerado por: ${tokenData.generatedBy}<br>
                    Vinculado ao ID: ${tokenData.deviceId || 'Nenhum'}<br>
                    Status: ${isExpired ? '<span class="text-red-500">Expirado</span>' : (isLinked ? '<span class="text-yellow-500">Vinculado</span>' : '<span class="text-green-500">Ativo, Não Vinculado</span>')}
                `;

                if (isExpired) {
                    validationResultDisplay.textContent = 'Token Expirado!';
                    validationResultDisplay.style.color = 'red';
                    showMessage('Este token não é mais válido.', true, messageValidator);
                    localStorage.removeItem('lastValidatedToken');
                    localStorage.removeItem('lastValidatedDeviceId');
                    return;
                }

                if (isLinked) {
                    if (tokenData.deviceId === currentDeviceId) {
                        validationResultDisplay.textContent = 'Token Válido e Vinculado a este Dispositivo!';
                        validationResultDisplay.style.color = 'lime';
                        showMessage('Você pode continuar a usar este token.', false, messageValidator);
                        localStorage.setItem('lastValidatedToken', tokenValue);
                        localStorage.setItem('lastValidatedDeviceId', currentDeviceId);
                        showAccessGrantedView(); // Show boss search section
                    } else {
                        validationResultDisplay.textContent = 'Token Já Vinculado a Outro Dispositivo!';
                        validationResultDisplay.style.color = 'orange';
                        showMessage('Este token não pode ser usado aqui.', true, messageValidator);
                        localStorage.removeItem('lastValidatedToken');
                        localStorage.removeItem('lastValidatedDeviceId');
                    }
                } else {
                    const confirmLink = await customModal('Este token é válido e não está vinculado. Deseja vinculá-lo a este dispositivo?', 'confirm');
                    if (confirmLink) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/generatedTokens`, tokenId), {
                            deviceId: currentDeviceId,
                            linkedAt: Date.now()
                        });
                        validationResultDisplay.textContent = 'Token Vinculado com Sucesso a este Dispositivo!';
                        validationResultDisplay.style.color = 'lime';
                        showMessage('O token agora está vinculado a este dispositivo e não pode ser usado em outro.', false, messageValidator);
                        localStorage.setItem('lastValidatedToken', tokenValue);
                        localStorage.setItem('lastValidatedDeviceId', currentDeviceId);
                        showAccessGrantedView(); // Show boss search section
                    } else {
                        validationResultDisplay.textContent = 'Token Válido (Não Vinculado)';
                        validationResultDisplay.style.color = 'white';
                        showMessage('Você optou por não vincular o token. Ele ainda pode ser usado em outros dispositivos.', false, messageValidator);
                        localStorage.removeItem('lastValidatedToken');
                        localStorage.removeItem('lastValidatedDeviceId');
                    }
                }

            } catch (error) {
                console.error("Erro na validação do token:", error);
                validationResultDisplay.textContent = 'Erro ao validar o token.';
                validationResultDisplay.style.color = 'red';
                showMessage(`Erro inesperado: ${error.message}`, true, messageValidator);
                localStorage.removeItem('lastValidatedToken');
                localStorage.removeItem('lastValidatedDeviceId');
            }
        });

        // --- Mob Search Logic (from boss.html) ---

        async function loadMobsData() {
            loadingMobsMessage.textContent = 'Carregando dados dos mobs...';
            try {
                const response = await fetch(JSON_DATA_URL);
                if (!response.ok) {
                    throw new Error(`Erro HTTP! status: ${response.status}`);
                }
                allMobsData = await response.json();
                loadingMobsMessage.classList.add('hidden');
                showMessage('Dados dos mobs carregados com sucesso. Digite para pesquisar.', false, searchMessage);
                renderMobs(allMobsData);
            } catch (error) {
                console.error("Erro ao carregar dados dos mobs:", error);
                loadingMobsMessage.textContent = 'Erro ao carregar dados dos mobs.';
                showMessage('Erro ao carregar dados dos mobs. Verifique a consola.', true, searchMessage);
                customModal('Não foi possível carregar os dados dos mobs. Verifique sua conexão ou o URL do arquivo JSON.', 'alert');
            }
        }

        function renderMobs(mobs) {
            mobListDiv.innerHTML = '';
            if (mobs.length === 0) {
                mobListDiv.innerHTML = '<p class="text-white text-center">Nenhum mob encontrado com os critérios de pesquisa.</p>';
                return;
            }

            mobs.forEach(mob => {
                const mobCard = document.createElement('div');
                mobCard.className = 'mob-card p-4 mb-2 rounded-md shadow-sm';
                mobCard.innerHTML = `
                    <p class="font-semibold text-black text-base break-all">Número: <span class="text-gray-800">${mob['Número'] || 'N/A'}</span></p>
                    <p class="text-black text-sm">Nome do Mob: <span class="text-gray-700">${mob['Nome do Mob'] || 'N/A'}</span></p>
                    <p class="text-black text-sm">Pontos: <span class="text-gray-700">${mob['Pontos'] !== null ? mob['Pontos'] : 'N/A'}</span></p>
                    <p class="text-black text-sm">Arquivo: <span class="text-gray-700">${mob['Arquivo'] || 'N/A'}</span></p>
                `;
                mobListDiv.appendChild(mobCard);
            });
        }

        function searchMobs() {
            const searchTerm = mobSearchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                renderMobs(allMobsData);
                showMessage('Exibindo todos os mobs.', false, searchMessage);
                return;
            }

            const filteredMobs = allMobsData.filter(mob => {
                const mobNumber = mob['Número'] ? String(mob['Número']).toLowerCase() : '';
                const mobName = mob['Nome do Mob'] ? String(mob['Nome do Mob']).toLowerCase() : '';

                return mobNumber.includes(searchTerm) || mobName.includes(searchTerm);
            });

            renderMobs(filteredMobs);
            if (filteredMobs.length > 0) {
                showMessage(`Encontrados ${filteredMobs.length} mobs.`, false, searchMessage);
            } else {
                showMessage('Nenhum mob encontrado com esta pesquisa.', true, searchMessage);
            }
        }

        // --- Logout Functionality ---
        logoutButton.addEventListener('click', () => {
            showValidatorView(); // Volta para a tela do validador
            console.log("Sessão encerrada. Limpando dados locais.");
        });

        // Event Listeners for search
        searchMobButton.addEventListener('click', searchMobs);
        mobSearchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchMobs();
            }
        });

        // The initial call to initCombinedApp is now handled by onAuthStateChanged.
        // This ensures Firebase is ready before attempting token validation.
    </script>
</body>
</html>
