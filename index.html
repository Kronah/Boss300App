<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Token - Acesso aos 300</title>
    <!-- Inclui o Tailwind CSS para estilização fácil -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define as fontes Inter (para texto geral) e Cinzel Decorative (para títulos) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Inclui Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Fonte padrão para todo o corpo */
            background-image:
                url('https://lh4.googleusercontent.com/_tiEzXvf6uDRZ1x-lkpcGl8tfFogCXcT9Qo5awoc_5C6oK_bIWabqjfGxafC48vLij-g6KOKSdgQg-_0gmKn99uwOPTY69Q4cghy3irecNGVHvz5hNHy6aqd5Fv3cqln1uu0eN0EFnJJp3SJfWXa2A4'); /* Imagem de fundo do exército de Esparta */
            background-size: cover; /* Faz a imagem cobrir todo o fundo */
            background-position: center; /* Centraliza a imagem no fundo */
            background-repeat: no-repeat; /* Evita que a imagem se repita */
            background-attachment: fixed; /* Mantém a imagem fixa ao rolar */
            display: flex; /* Para posicionar o conteúdo e o botão Sair */
            flex-direction: column; /* Coloca os itens em coluna */
            align-items: center; /* Centraliza horizontalmente */
            min-height: 100vh; /* Ocupa a altura total da viewport */
            padding: 1rem; /* Padding geral para o corpo */
        }
        /* Aplica a fonte "300" (Cinzel Decorative) aos títulos */
        h1, h2 {
            font-family: 'Cinzel Decorative', serif;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* Sombra para realçar o texto */
        }
        /* Estilo para painel de conteúdo */
        .content-panel {
            background-color: rgba(0, 0, 0, 0.5); /* Fundo escuro semi-transparente */
            padding: 2rem; /* Espaçamento interno */
            border-radius: 0.5rem; /* Cantos arredondados */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); /* Sombra */
            color: #ffffff; /* Cor do texto padrão para este painel */
            position: relative; /* Para posicionamento de elementos internos */
            width: 90%;
            max-width: 500px;
        }

        /* Estilos para o Modal Personalizado */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .custom-modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
    </style>
</head>
<body class="p-4">
    <!-- Container Principal do Validador -->
    <div class="content-panel mt-16 md:mt-4 text-center">
        <h1 class="text-3xl font-bold text-white mb-6">Validador de Token</h1>
        <p class="text-white text-lg mb-4" id="user-info">Aguardando autenticação...</p>
        <p class="text-white text-sm mb-4">Seu ID de Dispositivo: <span id="device-id-display" class="font-semibold break-all">Carregando...</span></p>

        <div class="space-y-4 mb-6">
            <div>
                <label for="tokenInput" class="block text-white text-sm font-semibold mb-2 text-left">Insira seu Token</label>
                <input
                    type="text"
                    id="tokenInput"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700 transition duration-200 placeholder-gray-600 text-black"
                    placeholder="Seu token único"
                >
            </div>
            <button
                id="validateTokenButton"
                class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-opacity-50 transition duration-300 transform hover:scale-105"
            >
                Validar Token
            </button>
            <p id="validationResult" class="text-center text-white text-base mt-4 font-semibold break-all"></p>
            <p id="tokenDetails" class="text-center text-white text-sm mt-2"></p>
            <p id="message" class="text-center text-sm mt-4"></p> <!-- Elemento para exibir mensagens de feedback -->
        </div>
    </div>

    <!-- Direitos autorais (agora no rodapé) -->
    <p class="text-center text-white text-xs mt-6">&copy; 2025 CaMoMiLa. Todos os direitos reservados.</p>

    <!-- Modal para Confirmação e Alertas -->
    <div id="customConfirmModal" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <p id="modalMessage" class="text-black text-lg mb-4"></p>
            <!-- Input para o modal, inicialmente oculto -->
            <input type="number" id="modalInput" class="hidden w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700 transition duration-200 placeholder-black mb-4" placeholder="Quantidade de dias" min="1" />
            <div id="modalButtons" class="flex justify-center space-x-4">
                <button id="modalConfirmButton" class="bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900">Confirmar</button>
                <button id="modalCancelButton" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK e Lógica da Aplicação -->
    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Variáveis globais (adaptadas para um novo repositório, app id deve ser diferente do outro)
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDVwW_stGdkYpArCLjqsDbBsUiaSihGsUE", // Sua chave API do Firebase
            authDomain: "bossdv-72d16.firebaseapp.com",
            databaseURL: "https://bossdv-72d16-default-rtdb.firebaseio.com",
            projectId: "bossdv-72d16",
            storageBucket: "bossdv-72d16.firebasestorage.app",
            messagingSenderId: "141528827265",
            appId: "1:141528827265:web:531737e108e484a0869480" // O appId do seu projeto Firebase (pode ser o mesmo do outro app se ambos usarem o mesmo projeto)
        });
        const firebaseConfig = JSON.parse(firebaseConfigString);
        const appId = 'default-app-id'; // Usar 'default-app-id' para coincidir com o caminho onde os tokens são guardados.

        // URL base do repositório Boss 300 (AJUSTE ESTA URL para o seu novo repositório se for diferente)
        const boss300AppBaseUrl = 'https://kronah.github.io/Boss300App/'; // Exemplo: https://SEU_USUARIO.github.io/SEU_REPOSITORIO_BOSS/

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referências aos elementos HTML
        const userInfoDisplay = document.getElementById('user-info');
        const deviceIdDisplay = document.getElementById('device-id-display');
        const tokenInput = document.getElementById('tokenInput');
        const validateTokenButton = document.getElementById('validateTokenButton');
        const validationResultDisplay = document.getElementById('validationResult');
        const tokenDetailsDisplay = document.getElementById('tokenDetails');
        const messageDisplay = document.getElementById('message');

        // Referências para o Modal Personalizado (copiado do outro app)
        const customConfirmModal = document.getElementById('customConfirmModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const modalButtons = document.getElementById('modalButtons');


        let currentDeviceId = ''; // Para armazenar o ID único do dispositivo

        // --- Funções de UI e Mensagens ---

        function showMessage(text, isError = false) {
            messageDisplay.textContent = text;
            if (isError) {
                messageDisplay.className = 'text-center text-sm mt-4 text-red-600 font-medium';
            } else {
                messageDisplay.className = 'text-center text-sm mt-4 text-green-600 font-medium';
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('pt-BR')} às ${date.toLocaleTimeString('pt-BR')}`;
        }

        // Função para exibir um modal de confirmação/alerta ou prompt personalizado
        function customModal(message, type = 'alert', inputOptions = {}) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');

                if (type === 'prompt') {
                    modalInput.classList.remove('hidden');
                    modalInput.type = inputOptions.type || 'text';
                    modalInput.placeholder = inputOptions.placeholder || '';
                    modalInput.value = inputOptions.value || '';
                    modalInput.min = inputOptions.min || '';
                    modalInput.max = inputOptions.max || '';
                    modalInput.focus();
                } else {
                    modalInput.classList.add('hidden');
                    modalInput.value = '';
                }

                modalButtons.classList.remove('hidden');
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');

                modalConfirmButton.onclick = null;
                modalCancelButton.onclick = null;

                if (type === 'confirm' || type === 'prompt') {
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        if (type === 'prompt') {
                            resolve(modalInput.value);
                        } else {
                            resolve(true);
                        }
                    };
                    modalCancelButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(false);
                    };
                } else {
                    modalConfirmButton.textContent = 'OK';
                    modalCancelButton.classList.add('hidden');
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(true);
                        modalConfirmButton.textContent = 'Confirmar';
                    };
                }
            });
        }

        // --- Lógica de Autenticação e ID do Dispositivo ---

        async function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = crypto.randomUUID(); // Gera um UUID único para o dispositivo
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Autenticação anónima para permitir acesso ao Firestore para validação
                try {
                    await signInAnonymously(auth);
                    user = auth.currentUser; // Atualiza o objeto user após a autenticação anónima
                    console.log("Sessão anónima iniciada."); // Log de depuração
                } catch (error) {
                    console.error("Erro na autenticação anónima:", error);
                    showMessage('Erro na autenticação. Por favor, tente novamente.', true);
                    userInfoDisplay.textContent = 'Erro ao carregar sessão.';
                    return;
                }
            }
            userInfoDisplay.textContent = `Sessão Iniciada como: ${user.isAnonymous ? 'Anónimo' : user.email}`;
            currentDeviceId = await getDeviceId(); // Obtém ou gera o ID do dispositivo
            deviceIdDisplay.textContent = currentDeviceId;

            // REMOVIDO: Lógica de verificação automática de token vinculado e redirecionamento daqui.
            // Esta lógica agora está primariamente em boss.html.
        });

        // --- Lógica de Validação e Vínculo do Token ---

        validateTokenButton.addEventListener('click', async () => {
            const tokenValue = tokenInput.value.trim();
            validationResultDisplay.textContent = '';
            tokenDetailsDisplay.textContent = '';
            showMessage('');

            if (!tokenValue) {
                showMessage('Por favor, insira um token para validar.', true);
                return;
            }

            try {
                // Decodifica o token (simplesmente inverte a codificação base64)
                let decodedToken;
                try {
                    decodedToken = atob(tokenValue);
                } catch (e) {
                    showMessage('Token inválido. Formato incorreto (Base64).', true);
                    return;
                }

                // Tenta fazer uma query no Firestore pelo valor do token
                const tokensCollectionRef = collection(db, `artifacts/${appId}/public/data/generatedTokens`);
                console.log(`A procurar token na coleção: artifacts/${appId}/public/data/generatedTokens com valor: ${tokenValue}`); // Log de depuração
                const q = query(tokensCollectionRef, where("token", "==", tokenValue));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Token não encontrado. Verifique o valor.', true);
                    return;
                }

                const tokenDoc = querySnapshot.docs[0];
                const tokenData = tokenDoc.data();
                const tokenId = tokenDoc.id; // ID do documento no Firestore

                const now = Date.now();
                const isExpired = tokenData.expirationTimestamp <= now;
                const isLinked = !!tokenData.deviceId; // Verifica se já tem um deviceId

                tokenDetailsDisplay.innerHTML = `
                    Nome: ${tokenData.userName}<br>
                    Vence em: ${formatTimestamp(tokenData.expirationTimestamp)} ${isExpired ? '(EXPIRADO)' : ''}<br>
                    Gerado por: ${tokenData.generatedBy}<br>
                    Vinculado ao ID: ${tokenData.deviceId || 'Nenhum'}<br>
                    Status: ${isExpired ? '<span class="text-red-500">Expirado</span>' : (isLinked ? '<span class="text-yellow-500">Vinculado</span>' : '<span class="text-green-500">Ativo, Não Vinculado</span>')}
                `;

                if (isExpired) {
                    validationResultDisplay.textContent = 'Token Expirado!';
                    validationResultDisplay.style.color = 'red';
                    showMessage('Este token não é mais válido.', true);
                    // Limpar localStorage se o token validado manualmente estiver expirado
                    localStorage.removeItem('lastValidatedToken');
                    localStorage.removeItem('lastValidatedDeviceId');
                    return;
                }

                if (isLinked) {
                    if (tokenData.deviceId === currentDeviceId) {
                        validationResultDisplay.textContent = 'Token Válido e Vinculado a este Dispositivo!';
                        validationResultDisplay.style.color = 'lime'; // Cor verde vibrante
                        showMessage('Você pode continuar a usar este token.', false);
                        // Armazenar no localStorage antes de redirecionar
                        localStorage.setItem('lastValidatedToken', tokenValue);
                        localStorage.setItem('lastValidatedDeviceId', currentDeviceId);
                        // REDIRECIONAMENTO para a página Boss 300
                        window.location.href = `${boss300AppBaseUrl}boss.html`;
                    } else {
                        validationResultDisplay.textContent = 'Token Já Vinculado a Outro Dispositivo!';
                        validationResultDisplay.style.color = 'orange';
                        showMessage('Este token não pode ser usado aqui.', true);
                        // Limpar localStorage se o token validado manualmente estiver vinculado a outro deviceId
                        localStorage.removeItem('lastValidatedToken');
                        localStorage.removeItem('lastValidatedDeviceId');
                    }
                } else {
                    // Token válido e NÃO vinculado: Vincular ao dispositivo atual
                    const confirmLink = await customModal('Este token é válido e não está vinculado. Deseja vinculá-lo a este dispositivo?', 'confirm');
                    if (confirmLink) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/generatedTokens`, tokenId), {
                            deviceId: currentDeviceId,
                            linkedAt: Date.now()
                        });
                        validationResultDisplay.textContent = 'Token Vinculado com Sucesso a este Dispositivo!';
                        validationResultDisplay.style.color = 'lime';
                        showMessage('O token agora está vinculado a este dispositivo e não pode ser usado em outro.', false);
                        // Armazenar no localStorage após o vínculo e antes de redirecionar
                        localStorage.setItem('lastValidatedToken', tokenValue);
                        localStorage.setItem('lastValidatedDeviceId', currentDeviceId);
                        // REDIRECIONAMENTO para a página Boss 300 após o vínculo
                        window.location.href = `${boss300AppBaseUrl}boss.html`;
                    } else {
                        validationResultDisplay.textContent = 'Token Válido (Não Vinculado)';
                        validationResultDisplay.style.color = 'white';
                        showMessage('Você optou por não vincular o token. Ele ainda pode ser usado em outros dispositivos.', false);
                        // Limpar localStorage se o token não for vinculado
                        localStorage.removeItem('lastValidatedToken');
                        localStorage.removeItem('lastValidatedDeviceId');
                    }
                }

            } catch (error) {
                console.error("Erro na validação do token:", error);
                validationResultDisplay.textContent = 'Erro ao validar o token.';
                validationResultDisplay.style.color = 'red';
                showMessage(`Erro inesperado: ${error.message}`, true);
                // Limpar localStorage em caso de erro na validação
                localStorage.removeItem('lastValidatedToken');
                localStorage.removeItem('lastValidatedDeviceId');
            }
        });
    </script>
</body>
</html>
